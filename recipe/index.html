<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WITH | Recipe</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root {
      --gold-1: #f6e6a6;
      --gold-2: #e9c75f;
      --gold-3: #d4af37;
      --ink: #1d1d1f;
      --muted: #6e6e73;
      --card-bg: #ffffff;
      --card-border: rgba(0,0,0,0.08);
      --radius-outer: 24px;
      --radius-inner: 18px;
    }

    /* Apple-like hero */
    .hero-recipe {
      position: relative;
      min-height: 44vh;
      display: grid;
      place-items: center;
      text-align: center;
      color: #111;
      overflow: hidden;
      padding: 84px 20px 96px;
      background:
        radial-gradient(28% 45% at 75% 20%, rgba(255, 255, 255, 0.6), transparent 60%),
        conic-gradient(from 220deg at 50% 50%,
          color-mix(in oklab, var(--gold-3) 65%, #fff6cc) 0deg,
          color-mix(in oklab, var(--gold-3) 85%, #b68a1b) 140deg,
          color-mix(in oklab, var(--gold-3) 55%, #fff8da) 260deg,
          color-mix(in oklab, var(--gold-3) 65%, #fff6cc) 360deg);
    }
    .hero-recipe .badge { display:inline-flex; align-items:center; gap:10px; margin-bottom: 20px; }
    .hero-recipe .badge img { height: 36px; }
    .hero-recipe h1 { font-size: clamp(2rem, 6vw, 4rem); letter-spacing: -0.02em; line-height: 1; margin: 0 0 14px; font-weight: 900; }
    .hero-recipe p { max-width: 900px; margin: 0 auto; font-size: clamp(1rem, 2.1vw, 1.25rem); color: #2c2c2c; }

    /* Grid */
    .recipe-wrap { max-width: 1200px; margin: 28px auto 80px; padding: 0 20px; }
    .toolbar { display:flex; align-items:center; justify-content: space-between; gap: 12px; margin: 8px 0 16px; flex-wrap: wrap; }
    .count { color: var(--muted); font-size: 14px; }
    .search { flex: 1 1 280px; max-width: 420px; position: relative; }
    .search input {
      width: 100%; height: 44px; border-radius: 12px; border: 1px solid var(--card-border);
      padding: 0 40px 0 40px; outline: none; background:#fff;
    }
    .search svg { position:absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; }
    @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }

    .card { position: relative; border-radius: var(--radius-outer); overflow: hidden; background: var(--card-bg); border: 1px solid var(--card-border); box-shadow: 0 10px 30px rgba(0,0,0,.08); cursor: pointer; }
    .thumb { aspect-ratio: 4 / 3; width: 100%; background: #f5f5f7; display:block; object-fit: cover; }
    .meta { padding: 14px 16px 16px; display:grid; gap: 6px; }
    .eyebrow { font-size: 12px; color: var(--muted); letter-spacing: .02em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .title { font-size: 18px; font-weight: 800; color: var(--ink); line-height: 1.25; }
    .chips { display:flex; gap: 6px; flex-wrap: wrap; margin-top: 2px; }
    .chip { font-size: 12px; padding: 4px 8px; background:#f2f2f7; color:#222; border-radius:999px; }
    .card:hover { transform: translateY(-2px); transition: transform .15s ease; }

    /* Skeleton */
    .skeleton { animation: shimmer 1.2s linear infinite; background: linear-gradient(90deg, #f2f2f2 0%, #fafafa 50%, #f2f2f2 100%); background-size: 200% 100%; }
    @keyframes shimmer { to { background-position: -200% 0; } }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; place-items: center; z-index: 3000; background: rgba(0,0,0,.5); padding: 24px; }
    .modal.open { display: grid; }
    .dialog { width: min(960px, 100%); max-height: 92dvh; overflow: auto; background: #fff; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
    .dialog-header { display:flex; justify-content: space-between; align-items: center; padding: 18px 18px; border-bottom: 1px solid #eee; gap: 10px; }
    .dialog-title { font-size: 20px; font-weight: 800; }
    .close-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid rgba(0,0,0,.12); background: #f2f2f7; cursor: pointer; display:grid; place-items:center; }
    .dialog-body { display:grid; grid-template-columns: 1fr; gap: 14px; padding: 14px 18px 18px; }
    .dialog-visual img { width: 100%; height: auto; display:block; border-radius: 12px; }
    .caption { white-space: pre-wrap; line-height: 1.7; color: #222; }
    .ig-link { display:inline-flex; align-items:center; gap:8px; margin-top: 8px; font-weight: 600; }
    .timestamp { color: var(--muted); font-size: 12px; }
  </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9C4N2TREHT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-9C4N2TREHT');
  </script>
</head>
<body>
  <header class="site-header" role="navigation" aria-label="Primary Navigation">
    <nav class="nav">
      <a class="brand" href="/"><img class="brand-logo" src="../svg/onlyu.svg" alt="그이름 로고" />&nbsp;함께 WITH</a>
      <ul class="nav-menu">
        <li><a href="/music">MUSIC</a></li>
        <li><a href="/yield">YIELD</a></li>
        <li><a href="/recipe">RECIPE</a></li>
        <li><a href="https://jjhoil.com">SHOP</a></li>
      </ul>
      <button class="nav-toggle" aria-label="메뉴 열기" aria-controls="mobileMenu" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </nav>
  </header>
  <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
    <div class="mm-inner">
      <div class="mm-header">
        <button class="mm-close" aria-label="메뉴 닫기">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <nav>
        <ul>
          <li><a href="/music">MUSIC</a></li>
          <li><a href="/yield">YIELD</a></li>
          <li><a href="/recipe">RECIPE</a></li>
          <li><a href="https://jjhoil.com">SHOP</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <main>
    <section class="hero-recipe">
      <div>
        <div class="badge"><img src="../svg/recipe.svg" alt="Recipe" /></div>
        <h1>양심으로 완성하는 레시피</h1>
        <p>인스타그램의 최신 레시피를 한눈에. 애플 홈페이지 감성으로 깔끔하게 즐겨보세요.</p>
      </div>
    </section>

    <section class="recipe-wrap">
      <div class="toolbar">
        <div class="count" id="count">불러오는 중…</div>
        <label class="search" aria-label="레시피 검색">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 18a7 7 0 1 1 4.95-2.05L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="q" type="search" placeholder="제목, 해시태그 검색" />
        </label>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="recipeModal" role="dialog" aria-modal="true" aria-labelledby="dialogTitle">
    <div class="dialog">
      <div class="dialog-header">
        <div class="dialog-title" id="dialogTitle">레시피</div>
        <button class="close-btn" data-close>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6l12 12M18 6L6 18" stroke="#000" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="dialog-body">
        <div class="dialog-visual"><img id="dialogImage" alt="레시피 이미지" /></div>
        <div>
          <div class="timestamp" id="dialogTime"></div>
          <div class="caption" id="dialogCaption"></div>
          <p><a class="ig-link" id="dialogLink" target="_blank" rel="noopener">Instagram에서 보기 →</a></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://ig-feed-worker.gyulkiller.workers.dev/feed?hashtag=' + encodeURIComponent('양심기름레시피');
    const state = { items: [], filtered: [] };

    function extractHashtags(text) {
      if (!text) return [];
      const tags = (text.match(/#[^\s#]+/g) || []).map(t => t.trim());
      // 노이즈 제거: 너무 많은 브랜드/중복 태그는 상위 4개만 노출
      return Array.from(new Set(tags)).slice(0, 4);
    }
    function stripTags(text) { return String(text || '').replace(/#[^\s#]+/g, '').trim(); }
    function deriveTitle(caption) {
      const t = String(caption || '').trim();
      // 따옴표 안 키워드 우선
      const m = t.match(/["'“”‘’]([^"'“”‘’]+)["'“”‘’]/);
      if (m && m[1]) return m[1].replace(/#/g,'').trim();
      // 1행 제목 후보
      const firstLine = t.split(/\r?\n/)[0] || '';
      return stripTags(firstLine).replace(/^\p{P}+/u,'').trim() || '레시피';
    }
    function fmtTime(iso) {
      try { return new Intl.DateTimeFormat('ko-KR', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso)); } catch { return ''; }
    }
    function createCard(item) {
      const card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('role','button');
      card.setAttribute('tabindex','0');
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.src = item.media_url;
      img.alt = deriveTitle(item.caption) || '레시피 이미지';
      const meta = document.createElement('div'); meta.className = 'meta';
      const eyebrow = document.createElement('div'); eyebrow.className = 'eyebrow'; eyebrow.textContent = fmtTime(item.timestamp);
      const title = document.createElement('h3'); title.className = 'title'; title.textContent = deriveTitle(item.caption);
      const chips = document.createElement('div'); chips.className = 'chips';
      extractHashtags(item.caption).forEach(tag => { const c = document.createElement('span'); c.className = 'chip'; c.textContent = tag; chips.appendChild(c); });
      meta.appendChild(eyebrow); meta.appendChild(title); if (chips.childElementCount) meta.appendChild(chips);
      card.appendChild(img); card.appendChild(meta);
      const open = () => openModal(item);
      card.addEventListener('click', open);
      card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); open(); }});
      return card;
    }
    function render(list) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      list.forEach(it => grid.appendChild(createCard(it)));
      document.getElementById('count').textContent = list.length ? `레시피 ${list.length}개` : '검색 결과가 없습니다';
    }
    function filter(q) {
      const text = (q || '').toLowerCase();
      if (!text) { state.filtered = state.items.slice(); return; }
      state.filtered = state.items.filter(it => {
        const title = deriveTitle(it.caption).toLowerCase();
        const caps = String(it.caption||'').toLowerCase();
        return title.includes(text) || caps.includes('#'+text) || caps.includes(text);
      });
    }
    async function load() {
      const grid = document.getElementById('grid');
      // skeletons
      for (let i=0;i<6;i++) {
        const s = document.createElement('div'); s.className = 'card'; s.innerHTML = `<div class="thumb skeleton"></div><div class="meta"><div class="skeleton" style="height:12px; width:40%"></div><div class="skeleton" style="height:16px; width:70%; margin-top:8px"></div></div>`; grid.appendChild(s);
      }
      try {
        const res = await fetch(API, { mode: 'cors', cache: 'no-store' });
        const json = await res.json();
        const arr = Array.isArray(json?.data) ? json.data : [];
        state.items = arr.filter(x => x.media_type === 'IMAGE' && x.media_url).map(x => ({
          id: x.id,
          caption: x.caption || '',
          media_url: x.media_url,
          timestamp: x.timestamp,
          permalink: x.permalink
        }));
        filter(document.getElementById('q').value);
        render(state.filtered);
      } catch (e) {
        document.getElementById('count').textContent = '불러오기에 실패했습니다';
        grid.innerHTML = '';
        const msg = document.createElement('div');
        msg.style.cssText = 'padding:24px; border:1px solid var(--card-border); border-radius:12px;';
        msg.textContent = '네트워크 오류로 레시피를 불러오지 못했습니다. 새로고침 해주세요.';
        grid.appendChild(msg);
      }
    }

    function openModal(item) {
      const m = document.getElementById('recipeModal');
      document.getElementById('dialogTitle').textContent = deriveTitle(item.caption);
      const img = document.getElementById('dialogImage'); img.src = item.media_url; img.alt = deriveTitle(item.caption);
      document.getElementById('dialogTime').textContent = fmtTime(item.timestamp);
      document.getElementById('dialogCaption').textContent = item.caption || '';
      const a = document.getElementById('dialogLink'); a.href = item.permalink; a.setAttribute('href', item.permalink);
      m.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      const m = document.getElementById('recipeModal');
      m.classList.remove('open');
      document.body.style.overflow = '';
    }
    window.addEventListener('load', () => {
      load();
      const q = document.getElementById('q');
      q.addEventListener('input', () => { filter(q.value); render(state.filtered); });
      document.querySelector('[data-close]')?.addEventListener('click', closeModal);
      document.getElementById('recipeModal').addEventListener('click', (e)=>{ if (e.target === e.currentTarget) closeModal(); });
      window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });
    });
  </script>

  <script>
    (function(){
      const toggle = document.querySelector('.nav-toggle');
      const menu = document.getElementById('mobileMenu');
      const closeBtn = menu?.querySelector('.mm-close');
      function open(){ menu?.classList.add('open'); document.body.classList.add('menu-open'); toggle?.setAttribute('aria-expanded','true'); menu?.setAttribute('aria-hidden','false'); }
      function close(){ menu?.classList.remove('open'); document.body.classList.remove('menu-open'); toggle?.setAttribute('aria-expanded','false'); menu?.setAttribute('aria-hidden','true'); }
      toggle?.addEventListener('click', open);
      closeBtn?.addEventListener('click', close);
      menu?.addEventListener('click', (e)=>{ if(e.target===menu) close(); });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
  </script>
</body>
</html>


