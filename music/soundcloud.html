<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TH3NAME - SoundCloud Auto Player</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 20px;
    }
    .container {
      width: 100%;
      max-width: 960px;
    }
    h1 {
      font-size: 28px;
      margin: 0 0 8px;
    }
    p.desc { color: rgba(255,255,255,0.7); margin: 0 0 16px; }
    .controls { margin: 16px 0 20px; }
    button#startButton {
      background: #ffffff;
      color: #000;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    button#startButton[hidden] { display: none; }
    .player-wrap {
      background: #111;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      overflow: hidden;
    }
    iframe#sc-player {
      width: 100%;
      border: 0;
      display: block;
      background: transparent;
    }
    /* 데스크탑(클래식) / 모바일(비주얼) 높이 튜닝 */
    iframe#sc-player.classic { height: 300px; }
    iframe#sc-player.visual { height: 480px; }
    .hint { margin-top: 10px; color: rgba(255,255,255,0.55); font-size: 14px; }
  </style>
</head>
<body>
  <main class="container">
    <h1>TH3NAME</h1>
    <div class="controls">
      <button id="startButton">재생 시작</button>
    </div>
    <div id="priorityWrap" class="priority" style="display:none; margin: 8px 0 14px;">
      <div style="font-size:14px; color:rgba(255,255,255,0.7); margin-bottom:6px;">우선 재생</div>
      <div id="priorityList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>
    <div class="player-wrap">
      <iframe
        id="sc-player"
        title="SoundCloud player"
        scrolling="no"
        allow="autoplay"
        src="about:blank">
      </iframe>
    </div>
  </main>

  <script src="https://w.soundcloud.com/player/api.js"></script>
  <script>
    const iframe = document.getElementById('sc-player');
    const startButton = document.getElementById('startButton');
    const profileUrl = 'https://soundcloud.com/th3name';
    // 원하는 재생 순서를 아래 배열에 지정하세요.
    // 항목은 트랙 ID(숫자) 또는 트랙/세트의 전체 URL을 모두 지원합니다.
    // 예시)
    // const customOrder = [
    //   '2149175430', // api.soundcloud.com/tracks/<id>
    //   'https://soundcloud.com/th3name/stay-crisp',
    //   'https://api.soundcloud.com/tracks/2149183224'
    // ];
    const customOrder = ['https://soundcloud.com/th3name/stay-crisp?si=bf408ce63ff84163a204ddc529520728&utm_source=clipboard&utm_medium=text&utm_campaign=social_sharing'
    ,'https://soundcloud.com/th3name/midnight-drop?si=0fa7d281a10642cfa322bb9a7bec5401&utm_source=clipboard&utm_medium=text&utm_campaign=social_sharing'];

    let widget = null;
    let isReady = false;
    let hasUserStarted = false;
    let currentVisual = null; // boolean
    let currentIndex = 0; // custom 순서용
    let priorityPlan = [];
    let priorityCursor = 0;

    function buildPlayerSrc(resourceUrl, visual) {
      const params = new URLSearchParams({
        url: resourceUrl,
        auto_play: 'false',
        hide_related: 'true',
        show_comments: 'true',
        show_user: 'true',
        show_teaser: 'false',
        visual: visual ? 'true' : 'false'
      });
      return 'https://w.soundcloud.com/player/?' + params.toString();
    }

    function resolveTrackUrl(item) {
      if (/^https?:\/\//i.test(item)) return item;
      if (/^\d+$/.test(item)) return 'https://api.soundcloud.com/tracks/' + item;
      return item; // fallback
    }

    function stripQuery(u) {
      try {
        const x = new URL(u);
        x.search = '';
        x.hash = '';
        return x.toString().replace(/\/$/, '');
      } catch { return u; }
    }

    function isUsingCustomOrder() {
      return Array.isArray(customOrder) && customOrder.length > 0;
    }

    function currentCustomUrl() {
      return resolveTrackUrl(customOrder[currentIndex % customOrder.length]);
    }

    function enableAutoAdvance() {
      if (!widget) return;
      try { widget.unbind(SC.Widget.Events.FINISH); } catch (e) {}
      widget.bind(SC.Widget.Events.FINISH, function () {
        if (priorityCursor < priorityPlan.length) {
          const item = priorityPlan[priorityCursor++];
          if (item.type === 'index') {
            widget.skip(item.index);
            widget.play();
          } else {
            // fallback: 개별 URL (프로필 외 항목)
            widget.load(item.url, {
              auto_play: true,
              hide_related: true,
              show_comments: true,
              show_user: true,
              show_teaser: false,
              visual: currentVisual
            });
          }
        } else {
          widget.next();
        }
      });
    }

    function startPlayback() {
      if (!widget) return;
      enableAutoAdvance();
      if (priorityPlan.length > 0) {
        const first = priorityPlan[0];
        priorityCursor = 1;
        if (first.type === 'index') {
          widget.skip(first.index);
          widget.play();
        } else {
          widget.load(first.url, {
            auto_play: true,
            hide_related: true,
            show_comments: true,
            show_user: true,
            show_teaser: false,
            visual: currentVisual
          });
        }
      } else {
        widget.play();
      }
      startButton.setAttribute('hidden', 'true');
      hasUserStarted = true;
    }

    function onReady() {
      isReady = true;
      // 현재 목록 기준으로 우선 항목 매핑
      if (isUsingCustomOrder()) {
        widget.getSounds(function (sounds) {
          const urlToIndex = new Map();
          const idToIndex = new Map();
          sounds.forEach((s, i) => {
            if (s && s.permalink_url) urlToIndex.set(stripQuery(s.permalink_url), i);
            if (s && s.id != null) idToIndex.set(String(s.id), i);
          });
          priorityPlan = customOrder.map((raw) => {
            const url = resolveTrackUrl(raw);
            const urlNoQ = stripQuery(url);
            const idMatch = urlNoQ.match(/\/tracks\/(\d+)/);
            const id = idMatch ? idMatch[1] : null;
            let index = null;
            if (id && idToIndex.has(String(id))) index = idToIndex.get(String(id));
            else if (urlToIndex.has(urlNoQ)) index = urlToIndex.get(urlNoQ);
            if (index != null) {
              const title = sounds[index] && sounds[index].title ? sounds[index].title : '우선 항목';
              return { type: 'index', index, title };
            }
            return { type: 'url', url: urlNoQ, title: '우선 항목(개별)' };
          });
          renderPriorityList(priorityPlan);
          if (hasUserStarted) startPlayback();
        });
      } else {
        priorityPlan = [];
        document.getElementById('priorityWrap').style.display = 'none';
        if (hasUserStarted) startPlayback();
      }
    }

    function applyMode(visual) {
      if (currentVisual === visual) return;
      currentVisual = visual;
      iframe.classList.toggle('visual', visual);
      iframe.classList.toggle('classic', !visual);
      // 항상 프로필을 로드해 전체 목록을 보여줍니다
      iframe.src = buildPlayerSrc(profileUrl, visual);
      // 위젯 재초기화
      widget = SC.Widget(iframe);
      isReady = false;
      widget.bind(SC.Widget.Events.READY, onReady);
    }

    function isMobileVisual() {
      return window.matchMedia('(max-width: 768px)').matches;
    }

    function debounce(fn, wait) {
      let t;
      return function () {
        clearTimeout(t);
        t = setTimeout(fn, wait);
      };
    }

    startButton.addEventListener('click', function () {
      if (isReady) {
        startPlayback();
      } else if (widget) {
        widget.bind(SC.Widget.Events.READY, startPlayback);
      }
    });

    window.addEventListener('load', function () {
      applyMode(isMobileVisual());
      // 가능하면 즉시 재생 시도(차단될 수 있음)
      setTimeout(function () {
        enableAutoAdvance();
        if (widget) widget.play();
      }, 300);
    });

    window.addEventListener('resize', debounce(function () {
      applyMode(isMobileVisual());
    }, 200));

    function renderPriorityList(plan) {
      const wrap = document.getElementById('priorityWrap');
      const list = document.getElementById('priorityList');
      list.innerHTML = '';
      if (!plan || plan.length === 0) { wrap.style.display = 'none'; return; }
      wrap.style.display = '';
      plan.forEach((item, idx) => {
        const btn = document.createElement('button');
        btn.textContent = item.title || `우선 ${idx + 1}`;
        btn.style.cssText = 'background:#222;border:1px solid rgba(255,255,255,0.15);color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;';
        btn.addEventListener('click', () => {
          priorityCursor = idx + 1; // 이후 항목부터 이어서
          if (item.type === 'index') {
            widget.skip(item.index); widget.play();
          } else {
            widget.load(item.url, { auto_play: true, hide_related: true, show_comments: true, show_user: true, show_teaser: false, visual: currentVisual });
          }
        });
        list.appendChild(btn);
      });
    }
  </script>
</body>
</html>


