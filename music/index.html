<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TH3NAME - SoundCloud Auto Player</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 960px;
      margin: calc(var(--header-h, 56px) + 24px) auto 32px;
      padding: 0 20px;
    }
    /* Layout: stack on mobile, side-by-side on desktop */
    .music-layout { display: grid; gap: 18px; align-items: start; }
    @media (min-width: 980px) {
      .music-layout { grid-template-columns: 1fr 420px; }
    }
    h1 {
      font-size: 28px;
      margin: 0 0 8px;
    }
    p.desc { color: rgba(255,255,255,0.7); margin: 0 0 16px; }
    .controls { margin: 16px 0 20px; }
    button#startButton {
      background: #ffffff;
      color: #000;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    button#startButton[hidden] { display: none; }
    .player-wrap {
      background: #111;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      overflow: hidden;
    }
    iframe#sc-player {
      width: 100%;
      border: 0;
      display: block;
      background: transparent;
    }
    /* 데스크탑(클래식) / 모바일(비주얼) 높이 튜닝 */
    iframe#sc-player.classic { height: 300px; }
    iframe#sc-player.visual { height: 480px; }
    .hint { margin-top: 10px; color: rgba(255,255,255,0.55); font-size: 14px; }

    /* Animated warm orange gradient background */
    .gradient-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background:
        radial-gradient(60% 80% at 15% 20%, rgba(255, 140, 60, 0.50), transparent 60%),
        radial-gradient(70% 90% at 85% 25%, rgba(255, 190, 90, 0.45), transparent 60%),
        radial-gradient(70% 80% at 50% 85%, rgba(255, 90, 60, 0.40), transparent 60%),
        linear-gradient(180deg, #f3f3f3 0%, #ff8b8b 100%);
      background-blend-mode: screen, screen, screen, normal;
      background-size: 160% 160%, 160% 160%, 160% 160%, 100% 100%;
      background-position: 0% 0%, 100% 0%, 50% 100%, center;
      animation: gradientMove 3s ease-in-out infinite alternate;
      will-change: background-position;
    }

    @keyframes gradientMove {
      0%   { background-position: 0% 0%, 100% 0%, 50% 100%, center; }
      50%  { background-position: 40% 30%, 70% 40%, 40% 60%, center; }
      100% { background-position: 100% 100%, 0% 100%, 50% 0%, center; }
    }

    /* Album skin styles */
    .album-skin {
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 16px 60px rgba(0,0,0,0.35);
      background: #121212;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .album-cover {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      background: url('./img/visible_truth.png') center/cover no-repeat;
      filter: saturate(1.05) contrast(1.02);
    }
    .skin-overlay {
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 55%, rgba(0,0,0,0.66) 100%);
      pointer-events: none;
    }
    .skin-controls {
      position: absolute; left: 0; right: 0; bottom: 0;
      padding: 18px 16px 16px;
      display: grid; gap: 12px;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.55) 30%, rgba(0,0,0,0.75) 100%);
      color: #fff;
    }
    .skin-meta { display: grid; gap: 4px; }
    .skin-title { font-weight: 800; letter-spacing: -0.01em; font-size: 18px; }
    .skin-artist { opacity: 0.8; font-size: 13px; }
    .skin-buttons { display: inline-flex; gap: 10px; align-items: center; }
    .btn {
      display: inline-grid; place-items: center;
      width: 40px; height: 40px; border-radius: 999px;
      background: rgba(255,255,255,0.9); color: #111; border: none; cursor: pointer;
      transition: transform .15s ease, box-shadow .2s ease;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn--prev, .btn--next { background: rgba(255,255,255,0.18); color: #fff; border: 1px solid rgba(255,255,255,0.18); }
    .btn--play { width: 52px; height: 52px; background: #ffd24d; }
    .btn--repeat { position: relative; background: rgba(255,255,255,0.18); color: #fff; border: 1px solid rgba(255,255,255,0.18); }
    .btn--repeat.active { background: #ffd24d; color: #111; border-color: transparent; }
    .btn--repeat.mode-all, .btn--repeat.mode-one { background: #ffd24d; color: #111; border-color: transparent; }
    .btn--repeat.mode-one::after {
      content: '1';
      position: absolute;
      right: 6px;
      bottom: 4px;
      font-size: 12px;
      font-weight: 800;
      color: #111;
    }
    .progress { position: relative; height: 6px; background: rgba(255,255,255,0.18); border-radius: 999px; overflow: hidden; }
    .progress__bar { position: absolute; left: 0; top: 0; bottom: 0; width: 100%; transform-origin: left center; transform: scaleX(0); background: linear-gradient(90deg, #ffb84d, #ff7a59); }

    /* Track list */
    .tracks { margin-top: 14px; }
    .tracklist { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.12); border-radius: 14px; overflow: hidden; }
    .track { width: 100%; display: grid; grid-template-columns: 32px 1fr auto; align-items: center; gap: 12px; padding: 12px 14px; background: transparent; color: #fff; border: none; cursor: pointer; text-align: left; }
    .track + .track { border-top: 1px solid rgba(255,255,255,0.06); }
    .track:hover { background: rgba(255,255,255,0.06); }
    .track.active { background: rgba(255, 122, 89, 0.22); }
    .track .order { font-variant-numeric: tabular-nums; opacity: 0.8; }
    .track .info { display: grid; gap: 2px; }
    .track .title { font-weight: 700; letter-spacing: -0.01em; }
    .track .meta { font-size: 12px; opacity: 0.7; }
    .track .dur { font-variant-numeric: tabular-nums; opacity: 0.85; }
  </style>
</head>
<body>
  <div class="gradient-bg" aria-hidden="true"></div>
  <header class="site-header" role="navigation" aria-label="Primary Navigation">
    <nav class="nav">
      <a class="brand" href="/"><img class="brand-logo" src="../svg/onlyu.svg" alt="그이름 로고" />&nbsp;함께 WITH</a>
      <ul class="nav-menu">
        <li><a href="/music">MUSIC</a></li>
        <li><a href="/yield">YIELD</a></li>
        <li><a href="http://instagram.com/thenames_kr">RECIPE</a></li>
        <li><a href="https://jjhoil.com">SHOP</a></li>
      </ul>
      <button class="nav-toggle" aria-label="메뉴 열기" aria-controls="mobileMenu" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </nav>
  </header>
  <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
    <div class="mm-inner">
      <div class="mm-header">
        <button class="mm-close" aria-label="메뉴 닫기">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <nav>
        <ul>
          <li><a href="/music">MUSIC</a></li>
          <li><a href="/yield">YIELD</a></li>
          <li><a href="http://instagram.com/thenames_kr">RECIPE</a></li>
          <li><a href="https://jjhoil.com">SHOP</a></li>
        </ul>
      </nav>
    </div>
  </div>
  <main class="container music-layout">
    <div class="album-skin" role="region" aria-label="VISIBLE TRUTH player">
      <div class="album-cover" aria-hidden="true"></div>
      <div class="skin-overlay"></div>
      <div class="skin-controls">
        <div class="skin-meta">
          <div class="skin-title">VISIBLE TRUTH</div>
          <div class="skin-artist">TH3NAME</div>
        </div>
        <div class="skin-buttons">
          <button class="btn btn--prev" aria-label="이전 곡">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12l12-8v16L6 12z" fill="#fff"/></svg>
          </button>
          <button class="btn btn--play" aria-label="재생">
            <svg class="icon-play" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7L8 5z" fill="#111"/></svg>
            <svg class="icon-pause" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="#111"/></svg>
          </button>
          <button class="btn btn--next" aria-label="다음 곡">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 12L6 20V4l12 8z" fill="#fff"/></svg>
          </button>
          <button class="btn btn--repeat" aria-label="전체 반복" aria-pressed="false" title="전체 반복">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 7h7a3 3 0 0 1 0 6h-1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 17H10a3 3 0 0 1 0-6h1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 7l2 2-2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 17l-2-2 2-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="progress" aria-label="재생 진행도" role="slider" tabindex="0">
          <div class="progress__bar"></div>
    </div>
    </div>
      <iframe id="sc-backend" title="SoundCloud backend" allow="autoplay" style="position:absolute; width:1px; height:1px; border:0; opacity:0; pointer-events:none;"></iframe>
    </div>
    <aside class="tracks" aria-label="곡 목록">
      <div id="tracklist" class="tracklist" role="list"></div>
    </aside>
  </main>

  <script src="https://w.soundcloud.com/player/api.js"></script>
  <script>
    window.manualTrackOverrides = {
      5: { title: '한 숟갈의 배려', durationMs: 267000 },
      6: { title: 'Seed of the End', durationMs: 232000 },
      7: { title: '생명을 일으키는 밑거름', durationMs: 265000 }
    };
  </script>
  <script>
    const backend = document.getElementById('sc-backend');
    const playBtn = document.querySelector('.btn--play');
    const iconPlay = playBtn.querySelector('.icon-play');
    const iconPause = playBtn.querySelector('.icon-pause');
    const prevBtn = document.querySelector('.btn--prev');
    const nextBtn = document.querySelector('.btn--next');
    const repeatBtn = document.querySelector('.btn--repeat');
    const progress = document.querySelector('.progress');
    const progressBar = document.querySelector('.progress__bar');
    const trackListEl = document.getElementById('tracklist');

    const playlistUrl = 'https://api.soundcloud.com/playlists/2063852271';
    // 수동 보강용(필요 시 사용자 지정 가능). 예: window.manualTrackOverrides = {5:{title:'곡6', durationMs:191000}}
    const manualTrackOverrides = (window.manualTrackOverrides || (() => {
      try { return JSON.parse(localStorage.getItem('music_overrides') || '{}'); } catch(_) { return {}; }
    })());
      const params = new URLSearchParams({
      url: playlistUrl,
        auto_play: 'false',
        hide_related: 'true',
      show_comments: 'false',
      show_user: 'false',
      show_reposts: 'false',
        show_teaser: 'false',
      visual: 'false'
    });
    // iOS 인앱/사파리에서 사용자 제스처 직후 즉시 초기화되도록 지연 로드하지 않음
    backend.src = 'https://w.soundcloud.com/player/?' + params.toString();

    let widget = null;
    let isPlaying = false;
    let isWidgetReady = false;
    let sounds = [];
    let idToIndex = new Map();
    let repeatMode = 'off'; // 'off' | 'all' | 'one'
    let currentIndex = 0;

    function setPlayingUI(playing) {
      isPlaying = playing;
      iconPlay.style.display = playing ? 'none' : '';
      iconPause.style.display = playing ? '' : 'none';
      playBtn.setAttribute('aria-label', playing ? '일시정지' : '재생');
    }

    function setRepeatUI(mode) {
      repeatMode = mode === 'all' || mode === 'one' ? mode : 'off';
      if (repeatBtn) {
        repeatBtn.classList.toggle('active', repeatMode !== 'off');
        repeatBtn.classList.toggle('mode-all', repeatMode === 'all');
        repeatBtn.classList.toggle('mode-one', repeatMode === 'one');
        repeatBtn.setAttribute('aria-pressed', String(repeatMode !== 'off'));
        const label = repeatMode === 'one' ? '한 곡 반복 해제' : (repeatMode === 'all' ? '전체 반복 해제' : '반복 모드 설정');
        repeatBtn.setAttribute('aria-label', label);
        const title = repeatMode === 'one' ? '한 곡 반복' : (repeatMode === 'all' ? '전체 반복' : '반복 꺼짐');
        repeatBtn.setAttribute('title', title);
      }
      try { localStorage.setItem('repeat_mode', JSON.stringify(repeatMode)); } catch(_) {}
    }

    function cycleRepeatMode() {
      const next = repeatMode === 'off' ? 'all' : (repeatMode === 'all' ? 'one' : 'off');
      setRepeatUI(next);
    }

    function seekByClientX(clientX) {
      widget.getDuration(function (dur) {
        const rect = progress.getBoundingClientRect();
        const ratio = Math.min(1, Math.max(0, (clientX - rect.left) / rect.width));
        widget.seekTo(ratio * dur);
      });
    }

    function formatDuration(ms) {
      if (!ms || ms <= 0) return '—:—';
      const totalSec = Math.round(ms / 1000);
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return m + ':' + String(s).padStart(2, '0');
    }

    function deriveTitle(s) {
      const t = (s && s.title) ? String(s.title).trim() : '';
      if (t && t.toLowerCase() !== 'untitled') return t;
      const url = s && s.permalink_url ? s.permalink_url : '';
      try {
        const u = new URL(url);
        const slug = decodeURIComponent(u.pathname.split('/').filter(Boolean).pop() || '');
        if (slug) return slug.replace(/[-_]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      } catch {}
      return 'Track';
    }

    function renderTrackList(arr) {
      trackListEl.innerHTML = '';
      arr.forEach((s, i) => {
        const row = document.createElement('button');
        row.type = 'button';
        row.className = 'track';
        row.setAttribute('role', 'listitem');
        row.dataset.index = String(i);

        const order = document.createElement('span');
        order.className = 'order';
        order.textContent = String(i + 1).padStart(2, '0');

        const info = document.createElement('span');
        info.className = 'info';
        const title = document.createElement('span');
        title.className = 'title';
        const o = manualTrackOverrides[i] || {};
        const derived = deriveTitle(s);
        // 요청: 제목 뒤의 번호 제거
        title.textContent = o.title || derived;
        const meta = document.createElement('span');
        meta.className = 'meta';
        meta.textContent = (s && s.user && s.user.username) ? s.user.username : 'TH3NAME';
        info.appendChild(title);
        info.appendChild(meta);

        const dur = document.createElement('span');
        dur.className = 'dur';
        dur.textContent = formatDuration(o.durationMs != null ? o.durationMs : (s && s.duration));

        row.appendChild(order);
        row.appendChild(info);
        row.appendChild(dur);

        row.addEventListener('click', () => { try { widget.skip(i); widget.play(); } catch (_) {} });
        trackListEl.appendChild(row);
      });
    }

    function setActiveIndex(index) {
      const rows = trackListEl.querySelectorAll('.track');
      rows.forEach((el) => el.classList.toggle('active', Number(el.dataset.index) === Number(index)));
    }

    function updateTrackRowInfo(index, sound) {
      const row = trackListEl.querySelector('.track[data-index="' + index + '"]');
      if (!row || !sound) return;
      const titleEl = row.querySelector('.title');
      const durEl = row.querySelector('.dur');
      const o = manualTrackOverrides[index] || {};
      if (titleEl) titleEl.textContent = o.title || deriveTitle(sound);
      if (typeof sound.duration === 'number' && durEl) {
        durEl.textContent = formatDuration(o.durationMs != null ? o.durationMs : sound.duration);
      }
    }

    function hydrateAllTracks() {
      try { widget.setVolume(0); } catch(_) {}
      let originalIndex = 0;
      try { widget.getCurrentSoundIndex((idx) => { originalIndex = idx || 0; }); } catch(_) {}
      const total = sounds.length;

      let index = 0;

      function hydrateOne(targetIndex, attempt) {
        const retry = (nextAttemptDelayMs) => {
          const nextAttempt = (attempt || 0) + 1;
          if (nextAttempt <= 4) {
            setTimeout(() => hydrateOne(targetIndex, nextAttempt), nextAttemptDelayMs);
          } else {
            // 재시도 한계 초과: 다음 트랙으로 진행
            index = targetIndex + 1;
            step();
          }
        };

        try { widget.skip(targetIndex); } catch(_) {}

        // 점진적 백오프 (네트워크/위젯 로딩 지연 대비)
        const baseDelay = 600; // 기존 350ms -> 600ms로 증가
        const delay = baseDelay + (attempt || 0) * 300;

        setTimeout(() => {
          try {
            widget.getCurrentSound((cur) => {
              if (!cur || typeof cur.duration !== 'number' || cur.duration <= 0) {
                return retry(350);
              }
              updateTrackRowInfo(targetIndex, cur);
              index = targetIndex + 1;
              step();
            });
          } catch(_) {
            retry(350);
          }
        }, delay);
      }

      function step() {
        if (index >= total) {
          try { widget.skip(originalIndex); widget.setVolume(100); } catch(_) {}
          // 하이드레이션 종료 후, 누락된 제목은 oEmbed(JSONP)로 보완
          supplementTitlesWithOEmbed();
          return;
        }
        hydrateOne(index, 0);
      }

      step();
    }

    function isUnknownTitleText(text) {
      if (!text) return true;
      const t = String(text).trim().toLowerCase();
      return t === '' || t === 'untitled' || /^track\s+\d+/.test(t);
    }

    function supplementTitlesWithOEmbed() {
      sounds.forEach((s, i) => {
        const row = trackListEl.querySelector('.track[data-index="' + i + '"] .title');
        const current = row ? row.textContent : '';
        const o = manualTrackOverrides[i] || {};
        if (o.title || !(s && s.permalink_url)) return;
        if (!isUnknownTitleText(current)) return;
        requestOEmbedTitle(i, s.permalink_url);
      });
    }

    function requestOEmbedTitle(index, url) {
      const cb = '__scOE_' + index + '_' + Math.random().toString(36).slice(2);
      window[cb] = function (data) {
        try {
          const titleRaw = (data && data.title) ? String(data.title) : '';
          const title = titleRaw.split(' by ')[0] || titleRaw;
          const row = trackListEl.querySelector('.track[data-index="' + index + '"] .title');
          if (row && isUnknownTitleText(row.textContent)) row.textContent = title || row.textContent;
        } finally {
          try { delete window[cb]; } catch(_) {}
          const el = document.getElementById(cb);
          if (el) el.remove();
        }
      };
      const script = document.createElement('script');
      script.id = cb;
      script.src = 'https://soundcloud.com/oembed?format=json&url=' + encodeURIComponent(url) + '&callback=' + cb;
      script.referrerPolicy = 'no-referrer-when-downgrade';
      document.body.appendChild(script);
    }

    window.addEventListener('load', function () {
      widget = SC.Widget(backend);
      widget.bind(SC.Widget.Events.READY, function () {
        isWidgetReady = true;
        widget.getSounds(function (arr) {
          sounds = Array.isArray(arr) ? arr : [];
          idToIndex = new Map(sounds.map((s, i) => [String(s.id), i]));
          renderTrackList(sounds);
        });

        // progress loop
        widget.bind(SC.Widget.Events.PLAY, function () { setPlayingUI(true); });
        widget.bind(SC.Widget.Events.PAUSE, function () { setPlayingUI(false); });
        widget.bind(SC.Widget.Events.FINISH, function () {
          try {
            widget.getCurrentSoundIndex(function (idx) {
              const lastIndex = (sounds && sounds.length) ? sounds.length - 1 : -1;
              if (idx == null || lastIndex < 0) {
                try { widget.next(); } catch(_) {}
                return;
              }
              // 한 곡 반복 모드: 같은 트랙을 다시 재생
              if (repeatMode === 'one') {
                const target = (typeof currentIndex === 'number') ? currentIndex : (idx || 0);
                try { widget.skip(target); widget.play(); } catch(_) {}
                return;
              }
              if (idx >= lastIndex) {
                if (repeatMode === 'all') {
                  try { widget.skip(0); widget.play(); } catch(_) {}
                } else {
                  setPlayingUI(false);
                }
              } else {
                try { widget.next(); } catch(_) {}
              }
            });
          } catch(_) {}
        });
        widget.bind(SC.Widget.Events.PLAY_PROGRESS, function (e) {
          const pct = Math.max(0, Math.min(1, e.relativePosition || 0));
          progressBar.style.transform = 'scaleX(' + pct + ')';
        });
        widget.bind(SC.Widget.Events.PLAY, function () {
          try {
            widget.getCurrentSound(function (cur) {
              const idx = cur && cur.id != null ? idToIndex.get(String(cur.id)) : null;
              if (idx != null) {
                currentIndex = idx;
                setActiveIndex(idx);
              }
            });
          } catch(_) {}
        });

        // 메타데이터가 일부만 제공될 때, 모든 트랙을 순회하며 보강
        hydrateAllTracks();
      });

      playBtn.addEventListener('click', function () {
        if (!widget) return;
        if (!isWidgetReady) {
          const onReadyAndPlay = function () {
            isWidgetReady = true;
            try { widget.play(); } catch(_) {}
          };
          try { widget.bind(SC.Widget.Events.READY, onReadyAndPlay); } catch(_) {}
          return;
        }
        if (isPlaying) { widget.pause(); } else { widget.play(); }
      });
      prevBtn.addEventListener('click', () => { try { widget.prev(); } catch (_) {} });
      nextBtn.addEventListener('click', () => { try { widget.next(); } catch (_) {} });
      if (repeatBtn) {
        repeatBtn.addEventListener('click', function () { cycleRepeatMode(); });
      }

      progress.addEventListener('click', (ev) => seekByClientX(ev.clientX));
      progress.addEventListener('keydown', (ev) => {
        if (ev.key === 'ArrowLeft' || ev.key === 'ArrowRight') {
          ev.preventDefault();
          widget.getDuration((dur) => {
            widget.getPosition((pos) => {
              const delta = (ev.key === 'ArrowRight' ? 5 : -5) * 1000; // 5s step
              widget.seekTo(Math.max(0, Math.min(dur, pos + delta)));
            });
          });
        }
      });
      // 초기 반복 상태 복원 (기존 repeat_all 호환)
      try {
        const savedMode = JSON.parse(localStorage.getItem('repeat_mode') || '"off"');
        if (savedMode === 'all' || savedMode === 'one' || savedMode === 'off') {
          setRepeatUI(savedMode);
        } else {
          const legacyAll = JSON.parse(localStorage.getItem('repeat_all') || 'false');
          setRepeatUI(legacyAll ? 'all' : 'off');
        }
      } catch(_) {
        setRepeatUI('off');
      }
    });
  </script>
  <script>
    (function(){
      const toggle = document.querySelector('.nav-toggle');
      const menu = document.getElementById('mobileMenu');
      const closeBtn = menu?.querySelector('.mm-close');
      function open(){ menu?.classList.add('open'); document.body.classList.add('menu-open'); toggle?.setAttribute('aria-expanded','true'); menu?.setAttribute('aria-hidden','false'); }
      function close(){ menu?.classList.remove('open'); document.body.classList.remove('menu-open'); toggle?.setAttribute('aria-expanded','false'); menu?.setAttribute('aria-hidden','true'); }
      toggle?.addEventListener('click', open);
      closeBtn?.addEventListener('click', close);
      menu?.addEventListener('click', (e)=>{ if(e.target===menu) close(); });
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
  </script>
</body>
</html>


